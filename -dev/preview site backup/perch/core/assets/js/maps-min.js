"undefined"==typeof Perch&&(Perch={},Perch.UI={},Perch.Apps={}),Perch.UI.Maps=function(){var e=function(){a(),$(window).on("Perch_Init_Editors",a)},a=function(){var e=$("input.map_adr");e.length&&e.each(function(e,a){var r=$(a),i={};if(!r.attr("data-map-built")){r.attr("data-map-built",!0);var p=r.parent().find("div.map"),g=p.find("img").remove(),d=!1,l=$('<div class="mapdiv"></div>').appendTo(p);l.css({width:p.attr("data-width"),height:p.attr("data-height")});var s=p.attr("data-mapid");if(n(s,"clat")){var c=new google.maps.LatLng(n(s,"clat"),n(s,"clng"));i={zoom:parseInt(n(s,"zoom"),10),center:c,mapTypeId:t(n(s,"type")),scrollwheel:!1}}else i={zoom:10,center:new google.maps.LatLng(51.5,-.11),mapTypeId:t("roadmap")},d=!0;var m=new google.maps.Map(l.get(0),i),u=new google.maps.LatLng(n(s,"lat"),n(s,"lng")),f=new google.maps.Marker({position:u,map:m});google.maps.event.addListener(m,"zoom_changed",function(){o(s,"zoom",m.getZoom())}),google.maps.event.addListener(m,"center_changed",function(){var e=m.getCenter();o(s,"clat",e.lat()),o(s,"clng",e.lng())}),google.maps.event.addListener(m,"maptypeid_changed",function(){o(s,"type",m.getMapTypeId())}),google.maps.event.addListener(m,"click",function(e){var a=e.latLng.lat(),t=e.latLng.lng();f.setPosition(new google.maps.LatLng(a,t)),o(s,"lat",a),o(s,"lng",t)});var v=$('<a href="#" class="map-find button button-simple action-info">'+Perch.UI.Helpers.icon("core/search",10)+" "+p.attr("data-btn-label")+"</a>");v.insertAfter(r),r.parents(".form-entry").addClass("input-action"),v.click(function(e){e.preventDefault(),p.removeClass("offscreen");var a=$(this).parent().find("input.map_adr").val();geocoder=new google.maps.Geocoder,geocoder.geocode({address:a},function(e,a){a==google.maps.GeocoderStatus.OK&&(m.setCenter(e[0].geometry.location),f.setPosition(e[0].geometry.location),o(s,"lat",e[0].geometry.location.lat()),o(s,"lng",e[0].geometry.location.lng()))})}),d&&p.addClass("offscreen"),$(window).on("Perch.FieldTypes.redraw",function(){google.maps.event.trigger(m,"resize")})}})},t=function(e){switch(e){case"roadmap":return google.maps.MapTypeId.ROADMAP;case"satellite":return google.maps.MapTypeId.SATELLITE;case"hybrid":return google.maps.MapTypeId.HYBRID;case"terrain":return google.maps.MapTypeId.TERRAIN;default:return google.maps.MapTypeId.ROADMAP}},n=function(e,a){var t=$("#"+e+"_"+a);return t.length?t.val():($("div[data-mapid="+e+"]").append('<input type="hidden" name="'+e+"_"+a+'" id="'+e+"_"+a+'" value="" />'),!1)},o=function(e,a,t){n(e,a),$("#"+e+"_"+a).val(t)};return{init:e}}(),jQuery(function($){Perch.UI.Maps.init()});